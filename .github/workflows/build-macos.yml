name: 'Build macOS App'

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'mae-windows/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Xcode Project
        run: |
          xcodebuild clean build \
            -project "Mae.xcodeproj" \
            -scheme "Mae" \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGN_ENTITLEMENTS="" \
            CODE_SIGNING_ALLOWED=YES

      - name: Package App to ZIP
        run: |
          cd build/Build/Products/Release
          # Remove assinaturas antigas de frameworks embutidos e re-assina tudo (Deep Sign)
          codesign --force --deep --sign - Mae.app
          # Zip the resulting .app bundle so it can be uploaded as an artifact/release
          zip -r Mae-macOS.zip Mae.app
          
      - name: Generate Sparkle Appcast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Baixar ferramentas do Sparkle versão 2.9.0 (a mais recente 2.x estável)
          curl -L -O https://github.com/sparkle-project/Sparkle/releases/download/2.9.0/Sparkle-2.9.0.tar.xz
          mkdir jq_sparkle && tar -xf Sparkle-2.9.0.tar.xz -C jq_sparkle
          
          # Criar o diretório final para o release e mover o zip
          mkdir -p release_folder
          mv build/Build/Products/Release/Mae-macOS.zip release_folder/
          
          # Fazer a assinatura do zip para o Appcast
          # Fornecer a chave via variável de ambiente pede que usemos o parâmetro -f (para assinar arquivo puro)
          # Porem o standard agora é usar o `-ed-key-file` com um arquivo gerado de forma extremamente segura sem quebras de linha:
          printf "%s" "$SPARKLE_PRIVATE_KEY" > eddsa_key
          ./jq_sparkle/bin/generate_appcast --ed-key-file eddsa_key --download-url-prefix "https://github.com/JGSimi/Project-Mae/releases/download/mac-app-v${{ github.run_number }}/" release_folder/
          rm eddsa_key

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: mac-app-v${{ github.run_number }}
          name: 'Mãe para macOS v${{ github.run_number }}'
          body: 'Release automatizado da versão nativa para macOS (Swift).'
          draft: false
          prerelease: false
          files: |
            release_folder/Mae-macOS.zip
            release_folder/appcast.xml

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Mae-macOS-Package
          path: |
            release_folder/Mae-macOS.zip
            release_folder/appcast.xml

      - name: Prepare Pages Deploy
        run: |
          mkdir -p pages_dir
          cp release_folder/appcast.xml pages_dir/

      - name: Deploy Appcast to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./pages_dir
          publish_branch: gh-pages
          force_orphan: true
